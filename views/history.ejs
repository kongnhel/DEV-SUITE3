<%- include('partials/header') %>

<style>
    :root { --primary: <%= theme %>; --bg: #020617; }
    body { background-color: var(--bg); color: #f8fafc; }

    /* Glassmorphism Search Bar */
    .search-glass {
        background: rgba(30, 41, 59, 0.4);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 24px;
    }

    /* Archive Card Upgrade */
    .archive-card { 
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.4));
        border: 1px solid rgba(255, 255, 255, 0.03);
        border-radius: 32px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .archive-card:hover { 
        border-color: var(--primary); 
        transform: translateY(-8px) scale(1.01);
        box-shadow: 0 20px 40px -20px var(--primary);
    }

    .shimmer-text {
        background: linear-gradient(90deg, #fff, var(--primary), #fff);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 5s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }
</style>

<main class="max-w-6xl mx-auto p-4 md:p-12 relative">
    <header class="text-center mb-16 animate-in fade-in slide-in-from-top-10 duration-1000">
        <h2 class="text-6xl md:text-8xl font-black shimmer-text italic uppercase leading-none mb-4">Neural Archive</h2>
        <p class="text-slate-500 font-mono text-[10px] tracking-[0.4em] uppercase">Encrypted Knowledge Logs from MongoDB Atlas</p>
    </header>

    <div class="search-glass p-4 mb-16 sticky top-4 z-50 shadow-2xl">
        <form action="/history" method="GET" class="flex flex-col md:flex-row gap-4">
            <div class="flex-1 relative">
                <input type="text" name="search" value="<%= currentSearch %>"
                    class="w-full bg-black/40 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-purple-500 transition-all text-white"
                    placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ·ûä·û∂·ûì·ûá·ûæ·ûÑ·ûò·üÅ·ûö·üÄ·ûì (·ûß. Java, Angkor)...">
            </div>
            
            <select name="tool" class="bg-black/40 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-purple-500 text-slate-300">
                <option value="ALL" <%= currentTool === 'ALL' ? 'selected' : '' %>>·ûÇ·üí·ûö·ûî·üã TOOLS ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</option>
                <option value="AI_TUTOR" <%= currentTool === 'AI_TUTOR' ? 'selected' : '' %>>AI Tutor</option>
                <option value="CODE_REVIEWER" <%= currentTool === 'CODE_REVIEWER' ? 'selected' : '' %>>Code Reviewer</option>
                <option value="K_IDA" <%= currentTool === 'K_IDA' ? 'selected' : '' %>>K-IDA Chat</option>
            </select>

            <button type="submit" class="bg-purple-600 hover:bg-purple-500 text-white px-10 py-4 rounded-2xl font-black text-sm transition-all active:scale-95 shadow-lg shadow-purple-500/20">
                FILTER
            </button>
        </form>
    </div>

    <div class="space-y-10">
        <% if (history.length > 0) { %>
            <% history.forEach(item => { %>
                <div class="archive-card p-8 md:p-12 group">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-10 border-b border-white/5 pb-8">
                        <div class="flex items-center gap-4">
                            <span class="px-4 py-2 bg-purple-500/10 border border-purple-500/20 rounded-xl text-[10px] font-black text-purple-400 tracking-widest">
                                <%= item.toolName %>
                            </span>
                            <span class="text-slate-500 font-mono text-[10px]">
                                <%= new Date(item.createdAt).toLocaleString('km-KH') %>
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-12">
                        <div class="lg:col-span-2">
                            <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-4 flex items-center gap-2">
                                <span class="h-1 w-4 bg-slate-700 rounded-full"></span> User Query
                            </h4>
                            <p class="text-2xl text-white font-light italic leading-tight">"<%= item.userInput %>"</p>
                        </div>

                        <div class="lg:col-span-3">
                            <div class="p-8 bg-white/[0.02] rounded-[32px] border border-white/5 relative overflow-hidden group-hover:border-purple-500/30 transition-all">
                                <h4 class="text-[10px] font-black text-purple-400 uppercase tracking-[0.3em] mb-6 flex items-center gap-2">
                                    <span class="h-1 w-6 bg-purple-500 rounded-full"></span> Neural Response
                                </h4>
                                <div class="text-lg text-slate-300 leading-relaxed font-light">
                                    <% if (typeof item.aiResponse === 'object') { %>
                                        <div class="space-y-4">
                                            <p class="italic">
                                                <%= item.aiResponse.explanation || item.aiResponse.answer || item.aiResponse.humorous_response || item.aiResponse.introduction || "Knowledge Retrieved Successfully" %>
                                            </p>
                                            <% if (item.aiResponse.full_code_snippet) { %>
                                                <div class="mt-4 p-4 bg-black/40 rounded-xl border border-white/5 font-mono text-sm text-cyan-400 overflow-x-auto">
                                                    <pre><code><%= item.aiResponse.full_code_snippet %></code></pre>
                                                </div>
                                            <% } %>
                                        </div>
                                    <% } else { %>
                                        <p><%= item.aiResponse %></p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="text-center py-32 opacity-30 border-2 border-dashed border-white/5 rounded-[50px]">
                <span class="text-8xl block mb-8">üõ∞Ô∏è</span>
                <p class="text-2xl font-mono uppercase tracking-[0.5em]">No neural footprints found in this sector</p>
                <a href="/" class="mt-8 inline-block text-purple-400 hover:text-white transition-all underline underline-offset-8">Return to Central Command</a>
            </div>
        <% } %>
    </div>
</main>

<%- include('partials/footer') %>